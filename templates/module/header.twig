{% TemplateInclude "html head" %}

{# set current language #}
{%- set selectedLangLabel = '' -%}
{%- for key, lang in languages -%}
  {%- if key == language -%}
    {%- set selectedLangLabel = lang -%}
  {%- endif -%}
{%- endfor -%}

{# set current currency #}
{%- set currentCurrency = app.session.has('currency_unit') ? app.session.get('currency_unit') : is_authorized() ? app.security.token.user.settingCurrency : get_entity_manager().find("EcCoreBundle:Currency", system_config("base_currency")) -%}
{%- set selectedCurrencyLabel = '' -%}
{%- for key , item in supported_currencies -%}
  {%- set currency = get_entity_manager().find("EcCoreBundle:Currency", item) -%}
  {%- set name = currency.code -%}
  {%- if name == currentCurrency -%}
    {%- set selectedCurrencyLabel = name -%}
  {%- endif -%}
{%- endfor -%}
{%- if not selectedCurrencyLabel -%}
  {%- set currency = get_entity_manager().find("EcCoreBundle:Currency", supported_currencies|first) -%}
  {%- set selectedCurrencyLabel = currency.code -%}
{%- endif -%}

<body class="lc-root">
  
  <a id="top"></a>
  
  <header class="l-header">
    
    {# Header controler (SP right) #}
    <nav class="l-navi only-sp">
      <ul class="l-navi__list">
        <li class="l-navi__item">
          <button class="l-navi__button js-lc--openModal" aria-controls="modalLangCurrency" aria-haspopup="true"><i class="l-navi__icon lc-icon--globe"></i><span class="l-navi__label">{{ selectedLangLabel }} / {{ selectedCurrencyLabel }}</span></button>
        </li>
      </ul>
    </nav>

    {# Header controler (PC & SP left) #}
    <nav class="l-navi">
      <ul class="l-navi__list">
        <li class="l-navi__item only-pc">
          <button class="l-navi__button js-lc--openModal" type="button" aria-controls="modalLangCurrency" aria-haspopup="true"><i class="l-navi__icon lc-icon--globe"></i><span class="l-navi__label">{{ selectedLangLabel }} / {{ selectedCurrencyLabel }}</span></button>
        </li>
        {%- if is_authorized() -%}
          <li class="l-navi__item"><a class="l-navi__button" href="{{ path('ec_client_consumer') }}"><i class="l-navi__icon lc-icon--user"></i><span class="l-navi__label">{{ #mypage# }}</span></a></li>
        {%- else -%}
          <li class="l-navi__item"><a class="l-navi__button" href="{{ path('application_frontend_auth_login') }}"><i class="l-navi__icon lc-icon--user"></i><span class="l-navi__label">{{ #login# }}</span></a></li>
        {%- endif -%}
      </ul>
    </nav>

      {# mypage navi #}
      {%- if is_authorized() -%}
        <div class="only-sp">
          {% TemplateInclude "mypage navi" %}
        </div>
      {%- endif -%}
    </div>
  </header>
    
  {# Modal: change currency and language #}
  <div class="lc-modal" id="modalLangCurrency">
    <div class="lc-modal__bg js-lc--closeModal"></div>
    <div class="lc-modal__body">
      <h3 class="lc-modal__title">{{ #lang_currency_setting# }}</h3>
      <dl class="lc-selectModalSettings">
        <div class="lc-selectModalSettings__item">
          <dt class="lc-selectModalSettings__label">{{ #lang_setting# }}</dt>
          <dd class="lc-selectModalSettings__detail">
            <div class="lc-selectBox">
              <select class="lc-selectBox__select js-lc--selectLanguage">
{%- for key, lang in languages -%}
                <option value="{{ key }}"{% if key == language %} selected="selected"{% endif %}>{{ lang }}</option>
{%- endfor -%}
              </select>
            </div>
          </dd>
        </div>
        <div class="lc-selectModalSettings__item">
          <dt class="lc-selectModalSettings__label">{{ #currency_setting# }}</dt>
          <dd class="lc-selectModalSettings__detail">
            <div class="lc-selectBox">
              <select class="lc-selectBox__select js-lc--selectCurrency">
                {%- for key , item in supported_currencies -%}
                  {%- set currency = get_entity_manager().find("EcCoreBundle:Currency", item) -%}
                  {%- set name = currency.code -%}
                  <option value="{{ name }}"{% if name == currentCurrency %} selected{% endif %}>{{ name }}</option>
                {%- endfor -%}
              </select>
            </div>
          </dd>
        </div>
      </dl>
      <p class="lc-modal__buttons">
        <button class="lc-button--submit js-lc--changeLangCurrency" type="button"><span class="lc-button__label">{{ #save_changes# }}</span><i class="lc-button__icon lc-icon--check"></i></button>
        <button class="lc-button--cancel js-lc--closeModal" type="button"><i class="lc-button__icon lc-icon--close"></i><span class="lc-button__label">{{ #cancel# }}</span></button>
      </p>
    </div>
    <script>
      $(function () {
        // change language and currency
        $('.js-lc--changeLangCurrency').on('click', function () {
          var finishAnotherChange = false;

          // change currency
          $.ajax({
            method: 'POST',
            url: '/currency/change',
            data: {
              currency_unit: $('.js-lc--selectCurrency').val()
            }
          }).done(function(result){
            if (finishAnotherChange) {
              location.reload();
            } else {
              finishAnotherChange = true;
            }
          }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error(textStatus + ': ' + errorThrown);
            $('.lc-modal').removeClass('is-active');
          });

          // change language
          $.ajax({
            method: 'POST',
            url: '/language/select',
            data: {
              select_language: $('.js-lc--selectLanguage').val()
            }
          }).done(function(result){
            if (finishAnotherChange) {
              location.reload();
            } else {
              finishAnotherChange = true;
            }
          }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error(textStatus + ': ' + errorThrown);
            $('.lc-modal').removeClass('is-active');
          });
        });
      });
    </script>
  </div>

  <main class="l-main">