<section class="lc-contentsInner lc-reviewsArchive">
  {%- set totalReviews = 0 -%}
  {%- for review in reviews -%}
    {%- set totalReviews = totalReviews + review.grade -%}
  {%- endfor -%}
  <header class="lc-reviewsArchive__header">
    <h2 class="lc-reviewsArchive__title">{{ #product_reviews# }}</h2>
    <p class="lc-reviewsArchive__total">{{ reviews|length }}ä»¶</p>
    {%- if (reviews|length > 0) -%}
      <p class="lc-reviewStars lc-reviewStars--large" data-grade="{{ (totalReviews / reviews|length)|abs }}"><span></span><span></span><span></span><span></span><span></span>
      </p>
      <p class="lc-reviewsArchive__number">{{ (totalReviews / reviews|length / 2)|price_format(1) }}</p>
    {%- endif -%}
  </header>
  {%- if (reviews|length > 0) -%}
    <ul class="lc-reviewsArchive__list">
      {%- for review in reviews -%}
        {%- if (loop.index <= 10) -%}
          <li class="lc-reviewsArchive__item">
            <div class="lc-reviewsArchive__reviewHeader">
              <p class="lc-reviewStars" data-grade="{{ review.grade }}"><span></span><span></span><span></span><span></span><span></span>
              </p>
              <h3 class="lc-reviewsArchive__reviewTitle">{{ review.title }}</h3>
            </div>
            <p class="lc-reviewsArchive__detail">{{ review.description|nl2br }}</p>
            <p class="lc-reviewsArchive__nickname">{{ review.nickname }}</p>
          </li>
        {%- endif -%}
      {%- endfor -%}
    </ul>
  {%- else -%}
    <div class="productDetail">
      <p>{{ #no_reviews# }}</p>
    </div>
  {%- endif -%}
  <p class="lc-contentsInner__buttons lc-contentsInner__buttons--horizontal">
    {%- if (reviews|length > 10) -%}
      <a class="lc-button--submit" href="/ec/product/1/"><span class="lc-button__label">More</span><i class="lc-button__icon lc-icon--arrowRight"></i></a>
    {%- endif -%}
    {%- if is_authorized() -%}
      <button class="lc-button--submit js-lc--openModal" type="button" aria-controls="modalLangAddReview" aria-haspopup="true"><span class="lc-button__label">{{ #write_review# }}</span><i class="lc-button__icon lc-icon--star"></i></button>
    {%- else -%}
      <a class="lc-button--submit" href="{{ path('application_frontend_auth_login') }}" target="_blank"><span class="lc-button__label">{{ #login_for_write_review# }}</span><i class="lc-button__icon lc-icon--user"></i></a>
    {%- endif -%}
  </p>

  {%- if is_authorized() -%}
    <div class="lc-modal" id="modalLangAddReview">
      <div class="lc-modal__bg js-lc--closeModal"></div>
      <div class="lc-modal__body lc-modal__body--wide">
        <h3 class="lc-modal__title">{{ #write_review_label# }}</h3>
        <form action="{{ path('ec_client_product_review_add') }}" method="POST" name="form1" id="review_submit" novalidate="novalidate">
          <ul class="lc-form">
            <li class="lc-form__item">
              <label class="lc-form__label lc-form__label--half">
                <h4 class="lc-form__title is-required">{{ #nickname_label# }}</h4>
                <p class="lc-form__detail js-lc--reviewNickname">
                  {{ form_widget(form.nickname) }}
                </p>
              </label>
            </li>
            <li class="lc-form__item">
              <label class="lc-form__label lc-form__label--plain">
                <h4 class="lc-form__title is-required">{{ #grade_label# }}</h4>
                <div class="lc-form__detail lc-form__detail--stars">
                  <input class="js-lc--reviewStarsInput" id="{{ form.grade.vars.id }}" name="{{ form.grade.vars.full_name }}" type="hidden" value="10">
                  <p class="lc-reviewStars lc-reviewStars--large js-lc--changeReviewStars" data-grade="10"><span></span><span></span><span></span><span></span><span></span>
                  </p>
                  <p class="lc-reviewStars__number js-lc--reviewStarsNumber">5</p>
                </div>
              </label>
            </li>
            <li class="lc-form__item">
              <label class="lc-form__label">
                <h4 class="lc-form__title is-required">{{ #title_label# }}</h4>
                <p class="lc-form__detail js-lc--reviewTitle">
                  {{ form_widget(form.title) }}
                </p>
              </label>
            </li>
            <li class="lc-form__item">
              <label class="lc-form__label">
                <h4 class="lc-form__title is-required">{{ #description_label# }}</h4>
                <p class="lc-form__detail js-lc--reviewDescription">
                  {{ form_widget(form.description) }}
                </p>
              </label>
            </li>
          </ul>
          <p class="lc-modal__buttons">
            <button class="lc-button--submit js-lc--reviewSubmit" type="submit"><span class="lc-button__label">{{ #send_review# }}</span><i class="lc-button__icon lc-icon--check"></i></button>
            <button class="lc-button--cancel js-lc--closeModal" type="button"><i class="lc-button__icon lc-icon--close"></i><span class="lc-button__label">{{ #cancel# }}<</span></button>
          </p>
        </form>
      </div>
    </div>
    <script>
      $(function () {
        /**
          * -------------------------------
          * Change Review Stars
          */
        var $reviewStars = $('.js-lc--changeReviewStars');
        $reviewStars.each(function () {
          var $reviewStar = $(this);
          var $reviewStarsNumber = $reviewStar.next('.js-lc--reviewStarsNumber');
          var $reviewStarsInput = $reviewStar.prev('.js-lc--reviewStarsInput');
          var currentReviewGrade = $reviewStar.data('grade');
          $reviewStar
            .on('mouseenter', function (e) {
              $reviewStar.addClass('is-changing');
            })
            .on('mouseleave', function (e) {
              $reviewStar.removeClass('is-changing');
              $reviewStar.attr('data-grade', currentReviewGrade);
              $reviewStarsNumber.text(currentReviewGrade / 2);
            })
          $reviewStar.children('span')
            .on('mousemove', function (e) {
              var index = $reviewStar.children('span').index(this) + 1;
              var x = e.pageX - this.getBoundingClientRect().left + window.pageXOffset;
              var isFull = (x / $(this).width() > 0.5) ? true : false;
              var reviewGrade = isFull ? index * 2 : index * 2 - 1;
              $reviewStar.attr('data-grade', reviewGrade);
              $reviewStarsNumber.text(reviewGrade / 2);
            })
            .on('click', function (e) {
              var index = $reviewStar.children('span').index(this) + 1;
              var x = e.pageX - this.getBoundingClientRect().left + window.pageXOffset;
              var isFull = (x / $(this).width() > 0.5) ? true : false;
              var reviewGrade = isFull ? index * 2 : index * 2 - 1;
              $reviewStar.attr('data-grade', reviewGrade);
              currentReviewGrade = reviewGrade;
              $reviewStarsNumber.text(currentReviewGrade / 2);
              $reviewStarsInput.val(currentReviewGrade);
            });
        });

        /**
          * -------------------------------
          * Post Review
          */
        var $form = {
          form: $("#review_submit"),
          nickname: $('#{{ form.nickname.vars.id }}'),
          title: $('#{{ form.title.vars.id }}'),
          description: $('#{{ form.description.vars.id }}'),
          grade: $('#{{ form.grade.vars.id }}'),
          submit: $('.js-lc--reviewSubmit')
        }

        // review form submit
        $form.form.on('submit', function(event) {
          // cancel submit
          event.preventDefault();
          var product_id = {{ product.id }};
          var nickname = $form.nickname.val();
          var title = $form.title.val();
          var description = $form.description.val();
          var grade = $form.grade.val();
          $form.submit.attr('disabled', true);
          $.ajax({
            type: "POST",
            url: "{{ path('ec_client_product_review_add') }}",
            data: {
              "product_id": product_id,
              "title": title,
              "description": description,
              "nickname": nickname,
              "grade": grade,
            },
          }).done(function(data) {
            $form.form.find(".error").remove();
            if (data.responseCode == '400') {
              // output error messages
              for (var i = 0; i < data.error_msg.length; i++) {
                if(String(data.error_msg[i]) == '{{ 'assert.product_review.nickname.blank'|trans({}, 'clients') }}' || String(data.error_msg[i]) == 'assert.product_review.nickname.blank') {
                  $('.js-lc--reviewNickname').append("<span class='error' style='color:red'>{{ 'assert.product_review.nickname.blank'|trans({}, 'clients') }}</span>");
                }
                if(String(data.error_msg[i]) == '{{ 'assert.product_review.title.blank'|trans({}, 'clients') }}' || String(data.error_msg[i]) == 'assert.product_review.title.blank') {
                  $('.js-lc--reviewTitle').append("<span class='error' style='color:red'>{{ 'assert.product_review.title.blank'|trans({}, 'clients') }}</span>");
                }
                if(String(data.error_msg[i]) == '{{ 'assert.product_review.description.blank'|trans({}, 'clients') }}' || String(data.error_msg[i]) == 'assert.product_review.description.blank') {
                  $('.js-lc--reviewDescription').append("<span class='error' style='color:red'>{{ 'assert.product_review.description.blank'|trans({}, 'clients') }}</span>");
                }
              }
            } else {
              // reset values
              $form.nickname.val('');
              $form.title.val('');
              $form.description.val('');
              $form.grade.val('');
              $form.form.find(".error").remove();

              // open modal notice
              openModalNotice('It was success posting your review.', 1500);
            }
          }).fail(function(xhr, status) {
            // open modal notice
            openModalNotice('It was fail posting your review.');
          }).always(function () {
            $form.submit.attr('disabled', false);
          });
        });
      });
    </script>
  {%- endif -%}{# is_authorized() #}
</section>